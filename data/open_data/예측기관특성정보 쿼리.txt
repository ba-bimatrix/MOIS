/* ============================================== 
TSC_FORST_ORG_CRTCT_INFO 예측기관특성정보 생성 및 데이터 삽입

- TSC_FORST_ORG_CRTCT_INFO_BAK 테이블 생성 및 데이터 삽입(VARCHAR형)
- TSC_FORST_ORG_CRTCT_INFO 테이블 생성 및 제약 조건, 설명 추가
- TSC_FORST_ORG_CRTCT_INFO_BAK 테이블 SELECT 및 INSERT (BAK TO ORIGIN)
============================================== */

CREATE TABLE TIBERO.TSC_FORST_ORG_CRTCT_INFO_BAK (
	STDR_YY VARCHAR(4) NOT NULL,
	ORG_CD VARCHAR(7) NOT NULL,
	POPUL_CNT VARCHAR(30),
	HOHOLD_CNT VARCHAR(30),
	RESI_CNT VARCHAR(30),
	BUGE_AMT VARCHAR(30),
	REGION_CD VARCHAR(20),
	ADMDSTRC_CD VARCHAR(20),
	FULL_SQUARE VARCHAR(30),
	ROAD_SQUARE VARCHAR(30),
	CULT_SQUARE VARCHAR(30),
	FORE_SQUARE VARCHAR(30),
	RIVER_SQUARE VARCHAR(30),
	COAST_ADJ_AT CHAR(1),
	INLAND_CTY_AT CHAR(1),
	PBORD_AMT	VARCHAR(30),
	TRSPT_AMT VARCHAR(30),                                                                            
	MNCP_AMT VARCHAR(30),
	LCPB_AMT VARCHAR(30),
	COAST_LEN VARCHAR(30),
	GVN_MNG_SQUARE VARCHAR(30),
	GVN_SPRT_SQUARE VARCHAR(30),
	ETC_SQUARE VARCHAR(30),
	DMG_STORM_FLOOD_AMT VARCHAR(30),
	CRTR_ID VARCHAR(20) NOT NULL,
	LAST_MODUSR_ID VARCHAR(20) NOT NULL,
	CREAT_DT VARCHAR(8) NOT NULL,
	LAST_MODF_DT VARCHAR(8) NOT NULL
);

CREATE TABLE TIBERO.TSC_FORST_ORG_CRTCT_INFO (
	STDR_YY VARCHAR(4) NOT NULL,
	ORG_CD VARCHAR(7) NOT NULL,
	POPUL_CNT NUMBER(15),
	HOHOLD_CNT NUMBER(15),
	RESI_CNT NUMBER(15),
	BUGE_AMT NUMBER(18,3),
	REGION_CD VARCHAR(20),
	ADMDSTRC_CD VARCHAR(20),
	FULL_SQUARE NUMBER(15,5),
	ROAD_SQUARE NUMBER(15,5),
	CULT_SQUARE NUMBER(15,5),
	FORE_SQUARE NUMBER(15,5),
	RIVER_SQUARE NUMBER(15,5),
	COAST_ADJ_AT CHAR(1),
	INLAND_CTY_AT CHAR(1),
	PBORD_AMT	NUMBER(18,3),
	TRSPT_AMT NUMBER(18,3),                                                                            
	MNCP_AMT NUMBER(18,3),
	LCPB_AMT NUMBER(18,3),
	COAST_LEN NUMBER(15,5),
	GVN_MNG_SQUARE NUMBER(15,5),
	GVN_SPRT_SQUARE NUMBER(15,5),
	ETC_SQUARE NUMBER(15,5),
	DMG_STORM_FLOOD_AMT NUMBER(18,3),
	CRTR_ID VARCHAR(20) NOT NULL,
	LAST_MODUSR_ID VARCHAR(20) NOT NULL,
	CREAT_DT DATE NOT NULL,
	LAST_MODF_DT DATE NOT NULL
);

ALTER TABLE TIBERO.TSC_FORST_ORG_CRTCT_INFO ADD CONSTRAINT PK_TSC_FORST_ORG_CRTCT_INFO PRIMARY KEY(STDR_YY, ORG_CD);

COMMENT ON TABLE TIBERO.TSC_FORST_ORG_CRTCT_INFO IS '예측기관특성정보';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.STDR_YY  IS '기준년';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.ORG_CD  IS '기관코드';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.POPUL_CNT  IS '인구수';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.HOHOLD_CNT  IS '가구수';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.RESI_CNT  IS '주택수';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.BUGE_AMT  IS '예산금액';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.REGION_CD  IS '권역코드';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.ADMDSTRC_CD  IS '행정구역코드';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.FULL_SQUARE  IS '전체면적';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.ROAD_SQUARE  IS '도로면적';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.CULT_SQUARE  IS '경지면적';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.FORE_SQUARE  IS '산림면적';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.RIVER_SQUARE IS '하천면적';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.COAST_ADJ_AT  IS '해안인접여부';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.INLAND_CTY_AT  IS '내륙도시여부';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.PBORD_AMT  IS '공공질서 세출 결산액';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.TRSPT_AMT IS '수송및교통 세출 결산액';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.MNCP_AMT  IS '자치단체 세출 결산액';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.LCPB_AMT IS '지방공공 세출 결산액';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.COAST_LEN IS '해안선 길이';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.GVN_MNG_SQUARE IS '정부 관리 필요 토지 면적';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.GVN_SPRT_SQUARE IS '정부 지원 필요 토지 면적';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.ETC_SQUARE IS '기타 토지 면적';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.DMG_STORM_FLOOD_AMT IS '풍수해 피해액';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.CRTR_ID  IS '생성자ID';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.LAST_MODUSR_ID  IS '최종수정자ID';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.CREAT_DT  IS '생성일시';
COMMENT ON COLUMN TIBERO.TSC_FORST_ORG_CRTCT_INFO.LAST_MODF_DT  IS '최종수정일시';

INSERT INTO TIBERO.TSC_FORST_ORG_CRTCT_INFO 
SELECT 
	STDR_YY , ORG_CD ,
	TO_NUMBER(POPUL_CNT) AS POPUL_CNT,
	TO_NUMBER(HOHOLD_CNT) AS HOHOLD_CNT,
	TO_NUMBER(RESI_CNT) AS RESI_CNT,
	TO_NUMBER(BUGE_AMT) AS BUGE_AMT,
	REGION_CD,
	ADMDSTRC_CD,
	TO_NUMBER(FULL_SQUARE) AS FULL_SQUARE,
	TO_NUMBER(ROAD_SQUARE) AS ROAD_SQUARE,
	TO_NUMBER(CULT_SQUARE) AS CULT_SQUARE,
	TO_NUMBER(FORE_SQUARE) AS FORE_SQUARE,
	TO_NUMBER(RIVER_SQUARE) AS RIVER_SQUARE,
	COAST_ADJ_AT,
	INLAND_CTY_AT,
	TO_NUMBER(PBORD_AMT) AS PBORD_AMT,
	TO_NUMBER(TRSPT_AMT) AS TRSPT_AMT,
	TO_NUMBER(MNCP_AMT) AS MNCP_AMT,
	TO_NUMBER(LCPB_AMT) AS LCPB_AMT,
	TO_NUMBER(COAST_LEN) AS COAST_LEN,
	TO_NUMBER(GVN_MNG_SQUARE) AS GVN_MNG_SQUARE,
	TO_NUMBER(GVN_SPRT_SQUARE) AS GVN_SPRT_SQUARE, 
	TO_NUMBER(ETC_SQUARE) AS ETC_SQUARE,
	TO_NUMBER(DMG_STORM_FLOOD_AMT) AS DMG_STORM_FLOOD_AMT,
	CRTR_ID,
	LAST_MODUSR_ID,
	CREAT_DT,
	LAST_MODF_DT
FROM TIBERO.TSC_FORST_ORG_CRTCT_INFO_BAK 

WITH ANALY_PERIOD AS (
			SELECT TO_CHAR(ADD_MONTHS(SYSDATE, -LEVEL*12),'YYYY') AS STDR_YY 
				FROM DUAL CONNECT BY LEVEL<=6
), CONSIS_CHECK AS (
			SELECT STND.STDR_YY,
				   CASE WHEN STND.STND_CNT=CPRN.CPRN_CNT THEN 'Y' ELSE 'N' END AS CHECK_RSLT
				FROM (SELECT STDR_YY , COUNT(*) AS STND_CNT 
			 		  	FROM TIBERO.TSC_FORST_ORG_CRTCT_INFO
			 	      GROUP BY STDR_YY) AS STND LEFT JOIN (
			 	      SELECT STDR_YY, COUNT(*) AS CPRN_CNT
						FROM TIBERO.TSC_FORST_ORG_CRTCT_INFO
				   	  WHERE POPUL_CNT IS NOT NULL AND HOHOLD_CNT IS NOT NULL
					    AND RESI_CNT IS NOT NULL AND BUGE_AMT IS NOT NULL
						AND REGION_CD IS NOT NULL AND ADMDSTRC_CD IS NOT NULL
						AND FULL_SQUARE IS NOT NULL AND ROAD_SQUARE IS NOT NULL
						AND CULT_SQUARE IS NOT NULL AND FORE_SQUARE IS NOT NULL
						AND RIVER_SQUARE IS NOT NULL AND COAST_ADJ_AT IS NOT NULL
						AND INLAND_CTY_AT IS NOT NULL AND PBORD_AMT IS NOT NULL
						AND TRSPT_AMT IS NOT NULL AND MNCP_AMT IS NOT NULL
						AND LCPB_AMT IS NOT NULL AND COAST_LEN IS NOT NULL
						AND GVN_MNG_SQUARE IS NOT NULL AND GVN_SPRT_SQUARE IS NOT NULL
						AND ETC_SQUARE IS NOT NULL AND DMG_STORM_FLOOD_AMT IS NOT NULL
					  GROUP BY STDR_YY) AS CPRN
			 ON STND.STDR_YY=CPRN.STDR_YY
)
SELECT 
	STDR_YY,
		ORG_CD,
		POPUL_CNT,
		HOHOLD_CNT,
		RESI_CNT,
		BUGE_AMT,
		REGION_CD,
		ADMDSTRC_CD,
		FULL_SQUARE,
		ROAD_SQUARE,
		CULT_SQUARE,
		FORE_SQUARE,
		RIVER_SQUARE,
		COAST_ADJ_AT,
		INLAND_CTY_AT,
		PBORD_AMT,
		TRSPT_AMT,
		MNCP_AMT,
		LCPB_AMT,
		COAST_LEN,
		GVN_MNG_SQUARE,
		GVN_SPRT_SQUARE,
		ETC_SQUARE,
		DMG_STORM_FLOOD_AMT
	FROM TIBERO.TSC_FORST_ORG_CRTCT_INFO
 WHERE STDR_YY IN (SELECT ANALY_PERIOD.STDR_YY
						FROM ANALY_PERIOD JOIN CONSIS_CHECK
					ON ANALY_PERIOD.STDR_YY=CONSIS_CHECK.STDR_YY
					WHERE CHECK_RSLT='Y'
				  )
